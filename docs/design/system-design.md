# 系统设计文档

## 1. 项目背景

### 1.1 业务场景
Flink 流式平台，用户在平台创建集群、作业并运行。平台负责维护作业稳定性。

### 1.2 痛点问题
- Flink 作业异常种类繁多，排查耗时
- 相同问题重复出现，缺乏知识积累
- 运维人员需要丰富经验才能快速定位

### 1.3 解决方案
构建 LLM 驱动的智能诊断 Agent，自动分析异常并给出修复建议。

## 2. 系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        Flink Platform                           │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐                         │
│  │ Cluster │  │ Cluster │  │ Cluster │  ...                    │
│  └────┬────┘  └────┬────┘  └────┬────┘                         │
│       │            │            │                               │
│       └────────────┼────────────┘                               │
│                    ▼                                            │
│           ┌────────────────┐                                    │
│           │ Exception Tool │  (收集异常事件)                     │
│           └───────┬────────┘                                    │
└───────────────────┼─────────────────────────────────────────────┘
                    ▼
            ┌───────────────┐
            │    MySQL      │  (异常数据存储)
            └───────┬───────┘
                    │ 定时轮询 (60s)
                    ▼
┌───────────────────────────────────────────────────────────────────┐
│                     Oceanus Agent                                  │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                  LangGraph Workflow                          │  │
│  │  ┌─────────┐  ┌──────────┐  ┌──────────┐  ┌───────┐  ┌────┐ │  │
│  │  │ Collect │→ │ Retrieve │→ │ Diagnose │→ │ Store │→ │Acc │ │  │
│  │  └─────────┘  └──────────┘  └──────────┘  └───────┘  └────┘ │  │
│  └─────────────────────────────────────────────────────────────┘  │
│                         │                │                         │
│                         ▼                ▼                         │
│                  ┌───────────┐    ┌────────────┐                  │
│                  │  Milvus   │    │  OpenAI    │                  │
│                  │ (知识库)   │    │  (LLM)     │                  │
│                  └───────────┘    └────────────┘                  │
└───────────────────────────────────────────────────────────────────┘
                    │
                    ▼ 写入诊断结果
            ┌───────────────┐
            │    MySQL      │
            └───────────────┘
```

### 2.2 数据流

1. **异常采集**: Flink 平台通过专用工具将异常事件上报到 MySQL
2. **定时扫描**: Agent 每 60 秒扫描 MySQL 获取待诊断异常
3. **知识检索**: 从 Milvus 检索相似历史案例和相关文档
4. **LLM 诊断**: 调用 GPT-4o-mini 进行诊断推理
5. **结果存储**: 将诊断结果写回 MySQL
6. **知识积累**: 高置信度诊断自动加入知识库

## 3. 核心组件

### 3.1 LangGraph 工作流

```
START
  │
  ▼
┌─────────┐     job_info == null?     ┌─────┐
│ collect │ ─────────────────────────→│ END │
└────┬────┘                           └─────┘
     │ job_info != null
     ▼
┌──────────┐
│ retrieve │  (RAG 知识检索)
└────┬─────┘
     │
     ▼
┌──────────┐     error & retry < 3?
│ diagnose │ ─────────────────────┐
└────┬─────┘                      │
     │ success                    │ retry
     ▼                            │
┌───────┐                         │
│ store │←────────────────────────┘
└───┬───┘
    │
    ▼
┌────────────┐
│ accumulate │  (高置信度案例入库)
└─────┬──────┘
      │
      ▼
    ┌─────┐
    │ END │
    └─────┘
```

### 3.2 服务层

| 服务 | 职责 | 关键接口 |
|------|------|----------|
| MySQLService | 异常数据和知识案例管理 | `get_pending_exception()`, `update_diagnosis_result()` |
| MilvusService | 向量检索 | `search_similar_cases()`, `search_doc_snippets()` |
| LLMService | LLM 调用 | `generate_diagnosis()`, `generate_embedding()` |

### 3.3 状态定义

```python
class DiagnosisState(TypedDict):
    job_info: Optional[JobInfo]           # 作业信息
    status: DiagnosisStatus               # 诊断状态
    retrieved_context: Optional[dict]     # 检索到的知识
    diagnosis_result: Optional[dict]      # 诊断结果
    start_time: str
    end_time: Optional[str]
    error: Optional[str]
    retry_count: int
```

## 4. 技术选型

| 组件 | 选型 | 理由 |
|------|------|------|
| Agent 框架 | LangGraph | 适合多步骤工作流，有状态管理 |
| 监控追踪 | LangSmith | 与 LangGraph 深度集成 |
| LLM | GPT-4o-mini | 性价比高，推理能力足够 |
| 向量数据库 | Milvus | 成熟稳定，支持大规模检索 |
| 定时调度 | APScheduler | 轻量级，适合批量处理 |

## 5. 扩展性设计

### 5.1 支持新异常类型
1. 在 `config/prompts.py` 添加异常类型描述
2. 在 `models/diagnosis.py` 更新 `ErrorClassification`
3. 添加相关文档到 Milvus 知识库

### 5.2 接入新 LLM
1. 创建新的 Service 类实现相同接口
2. 在 `config/settings.py` 添加配置
3. 在 `workflow/graph.py` 注入新服务

### 5.3 添加实时处理
1. 引入消息队列（Kafka）
2. 创建消费者替代定时扫描
3. 保持工作流逻辑不变

## 6. 性能考量

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 单次诊断延迟 | < 10s | 主要受 LLM API 影响 |
| 批量处理能力 | 100-1000/天 | 当前设计目标 |
| 知识检索延迟 | < 100ms | Milvus 向量检索 |

## 7. 监控指标

- 诊断成功率
- 平均诊断耗时
- LLM API 调用次数和成本
- 知识库命中率
- 高置信度诊断占比
