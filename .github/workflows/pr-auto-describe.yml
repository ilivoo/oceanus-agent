name: PR Auto Describe

on:
  pull_request:
    types: [opened]

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-describe:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate PR Description
        uses: actions/github-script@v8
        with:
          script: |
            const { execSync } = require('child_process');

            // 获取变更文件列表
            const base = context.payload.pull_request.base.sha;
            const head = context.payload.pull_request.head.sha;

            let diffStat = '';
            let changedFiles = [];

            try {
              diffStat = execSync(`git diff --stat ${base}...${head}`).toString();
              changedFiles = execSync(`git diff --name-only ${base}...${head}`)
                .toString()
                .trim()
                .split('\n')
                .filter(f => f);
            } catch (e) {
              console.log('Error getting diff:', e.message);
              diffStat = '无法获取变更统计';
            }

            // 获取 commit 信息
            let commits = [];
            try {
              const commitLog = execSync(
                `git log --oneline ${base}...${head}`
              ).toString();
              commits = commitLog.trim().split('\n').filter(c => c);
            } catch (e) {
              console.log('Error getting commits:', e.message);
            }

            // 分类变更文件
            const categories = {
              workflow: [],
              services: [],
              api: [],
              models: [],
              config: [],
              tests: [],
              docs: [],
              deploy: [],
              other: []
            };

            changedFiles.forEach(file => {
              if (file.includes('workflow/')) categories.workflow.push(file);
              else if (file.includes('services/')) categories.services.push(file);
              else if (file.includes('api/')) categories.api.push(file);
              else if (file.includes('models/')) categories.models.push(file);
              else if (file.includes('config/')) categories.config.push(file);
              else if (file.startsWith('tests/')) categories.tests.push(file);
              else if (file.endsWith('.md') || file.startsWith('docs/')) categories.docs.push(file);
              else if (file.startsWith('deploy/') || file.includes('Dockerfile')) categories.deploy.push(file);
              else categories.other.push(file);
            });

            // 生成变更概览
            let changesSummary = [];
            if (categories.workflow.length) changesSummary.push(`- 工作流: ${categories.workflow.length} 文件`);
            if (categories.services.length) changesSummary.push(`- 服务层: ${categories.services.length} 文件`);
            if (categories.api.length) changesSummary.push(`- API: ${categories.api.length} 文件`);
            if (categories.models.length) changesSummary.push(`- 模型: ${categories.models.length} 文件`);
            if (categories.config.length) changesSummary.push(`- 配置: ${categories.config.length} 文件`);
            if (categories.tests.length) changesSummary.push(`- 测试: ${categories.tests.length} 文件`);
            if (categories.docs.length) changesSummary.push(`- 文档: ${categories.docs.length} 文件`);
            if (categories.deploy.length) changesSummary.push(`- 部署: ${categories.deploy.length} 文件`);
            if (categories.other.length) changesSummary.push(`- 其他: ${categories.other.length} 文件`);

            // 构建描述
            const existingBody = context.payload.pull_request.body || '';

            // 检查是否已有自动生成内容
            if (existingBody.includes('<!-- AUTO-GENERATED-STATS -->')) {
              console.log('PR already has auto-generated content, skipping');
              return;
            }

            const autoGenerated = `

            <!-- AUTO-GENERATED-STATS -->
            ---

            ## 变更统计 (自动生成)

            ### 变更概览
            ${changesSummary.join('\n') || '无变更'}

            ### Commits (${commits.length})
            ${commits.slice(0, 10).map(c => `- \`${c}\``).join('\n')}
            ${commits.length > 10 ? `\n... 还有 ${commits.length - 10} 个 commit` : ''}

            ### 文件变更详情
            \`\`\`
            ${diffStat.slice(0, 2000)}${diffStat.length > 2000 ? '\n...(截断)' : ''}
            \`\`\`

            <details>
            <summary>变更文件列表 (${changedFiles.length} 个文件)</summary>

            ${changedFiles.map(f => `- \`${f}\``).join('\n')}

            </details>

            ---
            <!-- END-AUTO-GENERATED-STATS -->
            `;

            // 更新 PR 描述
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: existingBody + autoGenerated
            });

            console.log('PR description updated successfully');
