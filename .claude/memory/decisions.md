# 项目历史决策记录

此文件记录项目开发过程中的重要决策，供 AI 助手参考以保持一致性。

---

## 2024-01 架构初始化

### 选择 LangGraph 作为工作流引擎

- **决策**: 采用 LangGraph 而非 LangChain Agent
- **理由**: 需要可控的循环工作流，支持状态持久化
- **影响**: 工作流定义在 `workflow/graph.py`

### 选择 GPT-4o-mini 作为诊断模型

- **决策**: 使用 GPT-4o-mini 而非 GPT-4
- **理由**: 性价比更高，推理能力满足需求
- **影响**: 配置在 `OPENAI_MODEL` 环境变量

### 选择 Milvus 作为向量数据库

- **决策**: 自托管 Milvus 而非云服务
- **理由**: 数据安全要求，成本控制
- **影响**: 需要维护 Milvus 实例

---

## 技术债务记录

### TD-001: 缺少分布式锁

- **描述**: 多实例部署时可能重复处理同一异常
- **临时方案**: 使用 `SELECT ... FOR UPDATE SKIP LOCKED`
- **长期方案**: 引入 Redis 分布式锁

### TD-002: Embedding 缓存

- **描述**: 重复查询会重新计算 Embedding
- **影响**: 增加 OpenAI API 调用成本
- **计划**: 实现 Redis 缓存层

---

## 重要配置说明

### 置信度阈值

- **当前值**: 0.8
- **调整历史**:
  - 初始 0.7，发现误报较多
  - 调整为 0.85，有效诊断入库太少
  - 最终定为 0.8，平衡准确性和积累速度

### 重试次数

- **当前值**: 3 次
- **退避策略**: 指数退避，1-10 秒
- **原因**: OpenAI API 偶发限流

---

## AI 助手须知

1. **代码修改前**: 必须运行 `pre-commit run --all-files`
2. **新增依赖**: 必须添加到 `pyproject.toml`，禁止使用 `requirements.txt`
3. **数据库变更**: 必须同步更新 `scripts/init_db.sql`
4. **配置变更**: 必须更新 `.env.example`
5. **公共 API 变更**: 必须更新 `docs/api/` 文档
